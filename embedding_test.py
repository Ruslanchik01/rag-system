# pytest embedding_test.py -v -s
# чанки по 1000 символов
import os
import shutil
os.environ['HF_HOME'] = './.cache/huggingface'
os.environ['HF_HUB_DISABLE_SYMLINKS_WARNING'] = '1'

import nbimporter
import main

# print(main.hello_world("assing"))

from langchain.schema import Document
import pytest

def clear_test_db(path):
    if os.path.exists(path):
        shutil.rmtree(path)

clear_test_db('test_db/chroma0')
clear_test_db('test_db/chroma1')
clear_test_db('test_db/chroma2')
clear_test_db('test_db/chroma3')

embedding0, db0 = main.db_connection("uaritm/multilingual_en_ru_uk", "test_db/chroma0")
embedding1, db1 = main.db_connection("sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2", "test_db/chroma1")
embedding2, db2 = main.db_connection("sentence-transformers/paraphrase-multilingual-mpnet-base-v2", "test_db/chroma2")
embedding3, db3 = main.db_connection("intfloat/multilingual-e5-large-instruct", "test_db/chroma3")

@pytest.fixture
def dataset():
    chunks = ["""Навчальний рік складається з двох семестрів: осіннього (вересень–січень) та весняного (лютий–червень). Кожен семестр включає 15 навчальних тижнів і 2 тижні екзаменаційної сесії. Тиждень самостійної роботи (без аудиторних занять) проводиться між 7 і 8 навчальними тижнями за рішенням деканату. Реєстрація на навчальні дисципліни здійснюється за індивідуальним навчальним планом (ІНП). Період додавання/відмови триває перші 10 календарних днів семестру; зміни в ІНП після цього можливі лише за наказом декана. Академічна відпустка надається за заявою студента та за наявності підтвердних документів строком до 12 місяців; повернення – за заявою не пізніше ніж за 5 робочих днів до початку наступного семестру. Навчальні заняття проводяться очно або дистанційно згідно з розкладом; відпрацювання пропущених занять здійснюється у консультаційні години викладача. Календар навчального року оприлюднюється на сайті факультету не пізніше 15 серпня.""",
              """З дисципліни застосовується 100-бальна шкала з переведенням у національну та ECTS. Підсумкова оцінка (ПО) складається з: поточного контролю (ПК) — 60% і підсумкового контролю (іспит/залік) — 40%. До складу ПК входять модульні контрольні, лабораторні/практичні, тести та індивідуальні завдання; мінімальний бал допуску до підсумкового контролю — 40 із 60. Курс вважається складеним за умови ПО ≥ 60 балів. Перескладання підсумкового контролю дозволено не більше двох разів: перший раз — протягом поточної сесії безкоштовно, другий — протягом 30 календарних днів після завершення сесії на платній основі згідно з кошторисом. Апеляція результатів подається протягом 3 робочих днів після оголошення балів у деканат. Порушення академічної доброчесності (плагіат, списування) тягне за собою 0 балів за відповідний компонент і службове розслідування.""",
              """Курсові роботи виконуються на 2–4 курсах за навчальним планом. Обсяг — 25–35 сторінок основного тексту без додатків. Оформлення: шрифт Times New Roman, кегль 14, міжрядковий інтервал 1,5; поля — ліве 30 мм, праве 10 мм, верхнє та нижнє 20 мм; нумерація сторінок з другої; бібліографічні посилання — за ДСТУ 8302:2015. Робота подається на кафедру не пізніше ніж за 7 календарних днів до початку екзаменаційної сесії, разом із відгуком керівника. Перевірка на академічну доброчесність є обов’язковою; рівень оригінальності має становити не менше 70% за результатами внутрішньої системи. У разі показника <70% робота повертається на доопрацювання з терміном до 5 робочих днів. Навчальна практика триває 4 тижні на 2 курсі та 6 тижнів на 3 курсі; звітність включає щоденник, письмовий звіт і захист перед комісією кафедри.""",
              """Академічна мобільність студентів реалізується у формах: внутрішньої (навчання в іншому закладі в Україні) та міжнародної (навчання/стажування за кордоном). Тривалість може становити від 1 семестру до 1 навчального року. Для участі студент подає заяву, копії академічної довідки та мотиваційний лист. Відбір здійснює конкурсна комісія факультету за критеріями: середній бал ≥ 75 зі 100, рівень володіння іноземною мовою (не нижче B2 для міжнародних програм), рекомендація куратора. Результати затверджуються наказом ректора. Після повернення студент подає академічну довідку з приймаючого закладу; результати навчання перезараховуються у залікову книжку. Студенти з академічною заборгованістю або дисциплінарним стягненням до програм мобільності не допускаються.""",
              """Студенти зобов’язані дотримуватися дисципліни та поважати права інших учасників освітнього процесу. Забороняється перебування на заняттях у стані алкогольного чи наркотичного сп’яніння, використання мобільних телефонів без потреби, запізнення без поважних причин. Куріння, вживання алкоголю та азартні ігри на території університету заборонені. За порушення правил можуть бути застосовані дисциплінарні стягнення: зауваження, догана, відрахування. Відрахування можливе лише після повторних порушень або грубих проступків (бійка, крадіжка, знищення майна). Студент має право оскаржити дисциплінарне рішення протягом 10 календарних днів у комісії з етики. Також університет заохочує позитивну поведінку — відзнаки, рекомендації, стипендії. Студентам дозволяється користуватися бібліотекою, спортивними залами та лабораторіями згідно з розкладом і внутрішніми правилами.""",
              """Університетська бібліотека надає студентам і викладачам доступ до друкованих та електронних ресурсів. Користування безкоштовне за умови пред’явлення студентського або службового квитка. Термін користування підручником — 30 календарних днів з можливістю одноразового продовження ще на 15 днів. Видання з підвищеним попитом можуть надаватися на коротший строк (до 7 днів). У разі втрати книги користувач повинен відшкодувати її вартість або замінити ідентичним виданням. У бібліотеці діють читальні зали з вільним доступом до електронних баз даних. Читачі зобов’язані дотримуватися тиші, здавати речі у камери схову та не використовувати техніку бібліотеки в особистих цілях. За систематичні порушення доступ до послуг може бути обмежений на строк до 1 семестру.""",
              """Стипендіальне забезпечення поділяється на академічне та соціальне. Академічна стипендія призначається студентам денної форми навчання на основі рейтингу успішності; розмір визначається щороку урядом. Для отримання академічної стипендії студент повинен скласти всі іспити та заліки без академічних боргів, з середнім балом не нижче 70. Соціальна стипендія призначається пільговим категоріям (сироти, діти з інвалідністю, учасники бойових дій тощо) за поданими документами. Студенти можуть отримувати обидва види стипендій одночасно. Перевірка успішності для призначення академічних стипендій проводиться двічі на рік — після кожної екзаменаційної сесії. У разі втрати підстав для соціальної стипендії виплати припиняються з наступного місяця.""",
              """Практична підготовка є обов’язковою частиною освітньої програми. Види практики: навчальна, виробнича, переддипломна. Базами практики можуть бути підрозділи університету, підприємства, установи та організації, з якими укладено договори. Студент зобов’язаний вести щоденник практики, який підписує керівник від бази практики. Звіт про практику подається у письмовому вигляді з додатками (графіки, таблиці, документи) та захищається перед комісією кафедри. У разі невиконання програми практики студент вважається таким, що має академічну заборгованість. Практика може бути перенесена лише за поважних причин (хвороба, сімейні обставини) і з дозволу декана. Керівники практики відповідають за контроль дотримання правил охорони праці та техніки безпеки.""",
              """Вибіркові дисципліни становлять не менше 25% від загального обсягу освітньої програми. Формування переліку здійснюється кафедрами щороку, не пізніше 1 травня. Студент подає заявку на вибір дисциплін через електронну систему протягом 15 календарних днів після оприлюднення переліку. Мінімальна кількість студентів для відкриття групи — 15 осіб; у разі меншої кількості кафедра може запропонувати альтернативну дисципліну. Зміна вибору після закінчення періоду реєстрації не допускається, окрім випадків відрахування чи академічної мобільності. Результати вибору фіксуються в індивідуальному навчальному плані. У разі, якщо студент не подав заявку вчасно, дисципліни закріплюються за ним автоматично з переліку, що залишився. Вибіркові дисципліни оцінюються за тими ж правилами, що й обов’язкові.""",
              """Дипломна робота є завершальним етапом навчання і виконується студентами на 4 курсі бакалаврату або 2 курсі магістратури. Тема дипломної затверджується кафедрою не пізніше початку останнього навчального року. Керівник призначається наказом декана з числа викладачів профільної кафедри. Дипломна робота повинна мати обсяг 50–70 сторінок друкованого тексту, включати вступ, огляд літератури, аналітичну частину, власне дослідження, висновки та список джерел. Рівень оригінальності має бути не менше 75% за результатами перевірки в університетській системі. Робота подається на кафедру не пізніше ніж за 14 днів до початку державної атестації. Захист здійснюється публічно на засіданні державної екзаменаційної комісії, яка складається щонайменше з 5 членів, включно з головою від іншої установи.""",
              """Академічна доброчесність є обов’язковою нормою для всіх учасників освітнього процесу. До порушень належать: плагіат, самоплагіат, фабрикація та фальсифікація результатів, списування, використання сторонньої допомоги під час контрольних заходів, необґрунтоване співавторство. За порушення передбачені санкції: попередження, повторне виконання завдання, анулювання результатів роботи, виставлення 0 балів за дисципліну, відрахування. Рішення про стягнення приймає комісія з академічної доброчесності, створена при факультеті. Студент має право подати апеляцію протягом 5 робочих днів. Викладачі також зобов’язані дотримуватися норм доброчесності (коректність посилань, заборона фабрикації даних). Університет проводить щорічні тренінги для студентів і викладачів з питань академічної доброчесності.""",
              """Місця в гуртожитках надаються студентам денної форми навчання згідно з наказом ректора, пріоритет мають іногородні та пільгові категорії. Заселення здійснюється на підставі заяви, студентського квитка, паспорта та квитанції про оплату. Договір проживання укладається строком на 1 навчальний рік із можливістю продовження. Проживаючі зобов’язані дотримуватися правил внутрішнього розпорядку: дотримання тиші з 22:00 до 7:00, збереження майна, недопущення сторонніх осіб без дозволу коменданта. Забороняється вживання алкоголю, куріння, утримання тварин. За порушення передбачені стягнення: попередження, штраф, виселення. Оплата проживання здійснюється щомісяця до 10 числа. У разі відмови від місця студент має подати письмову заяву за 14 днів до виїзду.""",
              """Розклад занять формується навчальним відділом на підставі пропозицій кафедр та затверджується проректором з навчальної роботи. Він повинен бути оприлюднений не пізніше ніж за 10 календарних днів до початку семестру на сайті факультету та інформаційних стендах. Перший і останній пари в робочий день можуть починатися не раніше 8:00 та не пізніше 19:00. Перерва між парами становить 10 хвилин, велика перерва після другої пари — 20 хвилин. У розкладі враховуються побажання студентів щодо вільних днів для наукової роботи, але пріоритет має рівномірне навантаження. Зміни у розкладі можуть вноситися лише наказом деканату з повідомленням студентів не пізніше ніж за 2 робочі дні до змін. У разі форс-мажорних обставин (епідемія, технічні проблеми) розклад може переводитися в дистанційний формат за рішенням ректора.""",
              """Індивідуальний графік навчання може бути наданий студенту за наявності поважних причин: працевлаштування, догляд за дитиною, стан здоров’я, активна участь у спортивних чи наукових заходах. Для отримання індивідуального графіка студент подає заяву з підтвердними документами та погодженням куратора групи. Рішення ухвалюється деканом протягом 5 робочих днів. Індивідуальний графік передбачає можливість перескладання заліків та іспитів у визначений термін, а також виконання завдань у дистанційній формі. Студент з індивідуальним графіком зобов’язаний виконати весь обсяг навчальної програми в межах поточного семестру. У разі систематичного невиконання графіка рішення може бути скасоване, і студент повертається до загального розкладу.""",
              """Студенти можуть брати участь у наукових гуртках, конференціях, конкурсах та грантових програмах. Науково-дослідна робота є добровільною, але враховується при формуванні рейтингу успішності. Результати досліджень публікуються у студентських наукових виданнях, збірниках конференцій та можуть бути представлені у вигляді тез, статей чи презентацій. Заохочення за активну наукову діяльність: додаткові бали з дисциплін (до 10%), премії, рекомендації для участі у міжнародних програмах. Керівник гуртка або науковий керівник відповідає за організацію зустрічей не рідше одного разу на місяць. Фінансування студентських досліджень може здійснюватися за кошти університету або зовнішніх грантів. Порушення етики публікацій (плагіат, некоректні посилання) розглядаються комісією з академічної доброчесності.""",
              """Використання мультимедійних проєкторів, інтерактивних дощок, комп’ютерних класів та лабораторного обладнання здійснюється за попереднім записом. Відповідальність за справність техніки покладається на завідувача лабораторії або викладача. Студенти мають право користуватися обладнанням лише під наглядом викладача. Забороняється самовільне встановлення програмного забезпечення, копіювання ліцензійних програм і пошкодження техніки. У разі поломки студент зобов’язаний повідомити викладача негайно; у випадку доведеної вини студент відшкодовує збитки. Обладнання може використовуватися для освітніх і наукових цілей, але не для комерційних проєктів. Для дистанційного навчання університет забезпечує студентів корпоративними акаунтами з доступом до ліцензійних ресурсів (офісні пакети, системи відеоконференцій).""",
              """Канікули є невід’ємною частиною навчального року. Вони тривають не менше 8 тижнів сумарно протягом року і включають зимові (2 тижні у січні) та літні (6 тижнів у липні–серпні) періоди. Для студентів випускних курсів літні канікули скорочуються через проведення державної атестації, але не можуть бути меншими за 4 тижні. У разі потреби можуть встановлюватися додаткові канікули (наприклад, санітарно-епідемічні). Студенти мають право залишатися у гуртожитку під час канікул за умови сплати проживання. Академічна мобільність або практика може проводитися під час канікул за згодою студента. Розклад канікул оприлюднюється разом з навчальним календарем до 15 серпня кожного року.""",
              """Університет забезпечує студентам можливість займатися спортом у секціях та відвідувати тренажерні зали. Заняття у спортивних секціях є безкоштовними і проводяться 2–3 рази на тиждень під керівництвом викладачів кафедри фізичного виховання. Тренажерні зали доступні студентам за абонементами, які можна придбати на семестр або місяць. Університет щороку організовує спартакіади та міжфакультетські змагання. Студенти-спортсмени можуть отримати індивідуальний графік навчання. Медичний огляд перед заняттями спортом є обов’язковим і проводиться у студентській поліклініці. Порушення правил безпеки у спортивних залах тягне за собою відсторонення від занять на строк до 1 семестру. За значні спортивні досягнення студенти можуть бути відзначені преміями та стипендіями університету.""",
              """Кожен студент отримує корпоративну електронну пошту, яка використовується для офіційного листування, доступу до внутрішніх сервісів та освітніх платформ. Забороняється використовувати корпоративну пошту для спаму, комерційної реклами або поширення шкідливого ПЗ. Для роботи з електронними курсами застосовується система управління навчанням (LMS), де розміщуються лекції, завдання та форуми. Доступ до LMS надається з моменту зарахування студента. Викладачі зобов’язані публікувати навчальні матеріали не пізніше ніж за 3 дні до першої лекції. Систематичне невиконання завдань у LMS прирівнюється до пропусків занять. Для дистанційних іспитів використовується модуль прокторингу, який фіксує звук і відео під час складання. Порушення правил користування електронними ресурсами тягне за собою блокування акаунта та дисциплінарні заходи.""",
              """Медичне обслуговування студентів здійснюється у студентській поліклініці, що включає терапевтичне, стоматологічне та профілактичне відділення. Первинний огляд проводиться при зарахуванні, а далі — щорічні профілактичні огляди. Для відвідування занять фізичного виховання обов’язковою є медична довідка про допуск. У разі гострих захворювань студент має право на звільнення від занять на строк до 5 днів за довідкою лікаря; понад цей термін потрібне погодження з деканатом. Університет забезпечує вакцинацію проти сезонного грипу та інші профілактичні заходи. При необхідності направлення на спеціалізоване лікування видається студентській поліклінікою. Невиконання вимоги щодо щорічного огляду може призвести до недопуску до занять та практики.""",
              """Академічна відпустка може надаватися студенту за медичними показаннями, сімейними обставинами, військовою службою або іншими поважними причинами. Тривалість відпустки становить від 6 до 12 місяців. Для оформлення студент подає заяву, підтвердні документи та погодження деканату. На час відпустки студент зберігає статус, але не має права відвідувати заняття та складати іспити. Повернення здійснюється за заявою не пізніше ніж за 5 робочих днів до початку семестру. Якщо студент не подав заяву вчасно, він може бути відрахований. Після повернення студент зобов’язаний відновити навчання за тією ж або наступною програмою (залежно від змін навчального плану). Фінансова заборгованість має бути погашена до моменту оформлення відпустки.""",
              """Деканат є адміністративним підрозділом факультету, що координує навчальний процес. Основні функції: облік студентів, ведення особових справ, формування та контроль ІНП, підготовка наказів про зарахування, відрахування, поновлення. Деканат організовує складання заліково-екзаменаційних відомостей, видачу довідок та академічних довідок. Прийом студентів здійснюється у встановлені години (не менше 20 годин на тиждень). Усі звернення студентів реєструються в електронному журналі. Деканат має право ініціювати розгляд питань у вченій раді факультету. У випадку конфліктних ситуацій студенти можуть подавати скарги до деканату, які розглядаються протягом 10 робочих днів. Інформація про графік роботи деканату обов’язково розміщується на сайті факультету та інформаційних стендах.""",
              """Студентське самоврядування здійснюється через студентську раду факультету та університету. Рада обирається шляхом таємного голосування студентів строком на 1 рік. Основні завдання: захист прав та інтересів студентів, організація культурно-масових заходів, співпраця з адміністрацією, участь у розподілі стипендіального фонду. Студентська рада має право вносити пропозиції щодо поліпшення навчального процесу, брати участь у засіданнях вченої ради з правом дорадчого голосу. Рішення ради є обов’язковими для розгляду деканатом. Фінансування діяльності здійснюється за рахунок університетського бюджету та спонсорської допомоги. Студент, обраний до ради, зберігає право на академічну стипендію незалежно від навантаження. У разі неефективної роботи рада може бути переобрана достроково за ініціативою не менше 30% студентів факультету.""",
              """Переведення студентів можливе як в межах університету (з одного факультету чи спеціальності на інший), так і з інших закладів вищої освіти. Для переведення студент подає заяву на ім’я ректора та академічну довідку. Рішення ухвалюється наказом ректора після погодження з деканатом факультету, куди здійснюється переведення. При поновленні студент має право продовжити навчання на тому ж курсі або нижчому, залежно від академічної різниці. Академічна різниця складається у формі додаткових іспитів чи заліків протягом першого семестру після поновлення. Якщо різниця перевищує 10 кредитів ECTS, поновлення здійснюється на попередній курс. Переведення чи поновлення можливе лише за відсутності фінансової заборгованості перед університетом.""",
              """Державна атестація є завершальним етапом освітнього процесу та включає державні іспити і/або захист дипломної роботи. До атестації допускаються лише студенти, які виконали всі вимоги навчального плану та не мають академічної чи фінансової заборгованості. Розклад атестації оприлюднюється не пізніше ніж за місяць до її початку. Державна екзаменаційна комісія (ДЕК) призначається наказом ректора і складається з викладачів профільних кафедр та голови від іншого закладу освіти або наукової установи. Захист дипломної роботи відбувається публічно із веденням протоколу. Рішення ДЕК є остаточним і може бути оскаржене лише в межах апеляційної комісії університету протягом 3 робочих днів. Студенти, які не з’явилися на атестацію без поважних причин, вважаються такими, що отримали незадовільний результат."""
              ]

    # Переконайся, що ти бачиш порядок та вміст
    # print(list(enumerate(chunks)))

    # ПРИВ’ЯЗАННЯ ПИТАНЬ ДО КОНКРЕТНОГО ІНДЕКСУ ПІСЛЯ СПЛІТУ!
    # Переконайся, що саме ці індекси збігаються з print() вище
    questions = {
        0: ["Яка тривалість семестру та екзаменаційної сесії?", "Коли можна змінити ІНП?"],
        1: ["З чого формується підсумкова оцінка і який мінімум для допуску?", "Скільки перескладань дозволено і в які строки?"],
        2: ["Які основні вимоги до оформлення курсової?", "Коли подавати курсову і що, якщо оригінальність <70%?"],
        3: ["Які документи потрібні для участі у мобільності?", "Які умови відбору на міжнародні програми?"],
        4: ["Які можливі дисциплінарні стягнення?", "Чи можна оскаржити дисциплінарне рішення?"],
        5: ["Який термін користування підручником?", "Що робити у випадку втрати книги бібліотеки?"],
        6: ["Які умови отримання академічної стипендії?", "Чи можна отримувати одночасно академічну і соціальну стипендію?"],
        7: ["Що є обов’язковими документами студента під час практики?", "У яких випадках практика може бути перенесена?"],
        8: ["Який мінімальний відсоток вибіркових дисциплін має бути в освітній програмі і що відбувається, якщо група не набрала 15 осіб?", "У яких випадках студент може змінити вибір дисципліни після завершення періоду реєстрації?"],
        9: ["Які структурні елементи обов’язково повинна містити дипломна робота і який обсяг встановлений?", "Коли студент має подати дипломну роботу і хто входить до складу комісії на захисті? "],
        10: ["Які основні види академічних порушень перелічені в документі?", "Хто приймає рішення про дисциплінарні заходи та які можливі санкції передбачені?"],
        11: ["Які документи потрібні для заселення і на який строк укладається договір?", "Які правила проживання у гуртожитку та які наслідки їх порушення?"],
        12: ["У які строки публікується розклад занять і хто його затверджує?", "Які умови встановлені для початку та завершення занять протягом дня і які можливі перерви?"],
        13: ["Які документи необхідно подати для отримання індивідуального графіка навчання?", "Чи може студент продовжити семестр у межах індивідуального графіка?"],
        14: ["У якій формі можуть бути опубліковані результати студентських досліджень?", "Які види заохочення передбачені для студентів, що активно займаються наукою?"],
        15: ["Хто відповідає за справність обладнання і чи можуть студенти користуватися ним самостійно?", "У яких випадках студент зобов’язаний відшкодувати збитки за техніку?"],
        16: ["Яка мінімальна тривалість літніх канікул для випускників і чому вона скорочується?", "У яких випадках студент може залишатися в гуртожитку під час канікул?"],
        17: ["Яка різниця між відвідуванням спортивних секцій та тренажерних залів?", "Які вимоги обов’язкові перед початком занять спортом?"],
        18: ["Які обмеження існують щодо використання корпоративної пошти студента?", "Які вимоги встановлені до викладачів щодо публікації матеріалів у LMS?"],
        19: ["Які документи необхідні для відвідування занять фізичного виховання?", "Які наслідки можуть бути, якщо студент не пройшов щорічний медогляд?"],
        20: ["Які кроки потрібно зробити студенту для оформлення академічної відпустки?", "Які наслідки настають, якщо студент не подав заяву на повернення вчасно?"],
        21: ["Які документи може видати деканат студенту за запитом?", "У який строк деканат розглядає скарги студентів? "],
        22: ["Які основні завдання виконує студентська рада факультету?", "Які повноваження має рада у відносинах з вченою радою університету?"],
        23: ["Які документи необхідні для переведення студента в межах чи за межами університету?", "Які умови визначають, на який курс поновлюється студент після академічної різниці?"],
        24: ["Які умови обов’язкові для допуску студента до державної атестації?", "Хто входить до складу ДЕК і який строк публікації розкладу атестації?"],
    }

    return chunks, questions

@pytest.mark.parametrize("db", [db0, db1, db2, db3])
def test_retriever_with_metrics(dataset, db):
    chunks, questions = dataset

    # Документи з chunk_id у metadata
    docs = [
        Document(page_content=c, metadata={"chunk_id": i})
        for i, c in enumerate(chunks)
    ]

    db.add_documents(docs)
    retriever_top1 = db.as_retriever(search_kwargs={"k": 1})
    retriever_top3 = db.as_retriever(search_kwargs={"k": 3})
    retriever_top7 = db.as_retriever(search_kwargs={"k": 7})

    total, correct_top1, correct_top3, correct_top7 = 0, 0, 0, 0

    errors1 = []
    errors3 = []
    errors7 = []

    for gold_idx, qs in questions.items():
        for q in qs:
            total += 1
            result1 = retriever_top1.get_relevant_documents(q)
            assert result1, f"Ретрівер нічого не повернув для питання: {q!r}"


            got_idx1 = result1[0].metadata.get("chunk_id")

            if got_idx1 == gold_idx:
                correct_top1 += 1
            else:
                # Збираємо детальну діагностику
                errors1.append(
                    f"\n ❌ Top-1 fail Питання: {q}\n"
                    f"Очікуваний chunk_id: {gold_idx}\n"
                    f"Отриманий chunk_id:  {got_idx1}\n"
                )

            result3 = retriever_top3.get_relevant_documents(q)
            got_idx3 = [r.metadata.get("chunk_id") for r in result3]
            if gold_idx in got_idx3:
                correct_top3 += 1
            else:
                # Збираємо детальну діагностику
                errors3.append(
                    f"\n ❌ Top-7 fail Питання: {q}\n"
                    f"Очікуваний chunk_id: {gold_idx}\n"
                    f"Отримані chunk_id:  {got_idx3}\n"
                )

            result7 = retriever_top7.get_relevant_documents(q)
            got_idx7 = [r.metadata.get("chunk_id") for r in result7]
            if gold_idx in got_idx7:
                correct_top7 += 1
            else:
                # Збираємо детальну діагностику
                errors7.append(
                    f"\n ❌ Top-7 fail Питання: {q}\n"
                    f"Очікуваний chunk_id: {gold_idx}\n"
                    f"Отримані chunk_id:  {got_idx7}\n"
                )

    # Можеш вимагати 100% або, наприклад, >= 0.8 для більших датасетів
    acc_top1 = correct_top1 / total if total else 0.0
    acc_top3 = correct_top3 / total if total else 0.0
    acc_top7 = correct_top7 / total if total else 0.0

    print(f"Top-1 accuracy = {acc_top1:.2%} ({correct_top1}/{total})")
    print(f"Top-3 accuracy = {acc_top3:.2%} ({correct_top3}/{total})")
    print(f"Top-7 accuracy = {acc_top7:.2%} ({correct_top7}/{total})")

    assert acc_top1 >= 0.6, (
        f"Top-1 accuracy = {acc_top1:.2%}, помилок: {len(errors1)}. "
        f"Деталі:\n{''.join(errors1)}"
    )
    assert acc_top3 >= 0.8, (
        f"Top-3 accuracy = {acc_top3:.2%}, помилок: {len(errors3)}. "
        f"Деталі:\n{''.join(errors3)}"
    )
    assert acc_top7 == 1, (
        f"Top-7 accuracy = {acc_top7:.2%}, помилок: {len(errors7)}. "
        f"Деталі:\n{''.join(errors7)}"
    )

